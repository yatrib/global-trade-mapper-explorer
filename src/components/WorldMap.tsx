
import React, { useState, useEffect } from 'react';
import { CountryData, MetricType } from '../data/types';
import { countryData, getCountryColor } from '../data/countries';
import { Search } from "lucide-react";
import { Input } from "@/components/ui/input";

interface WorldMapProps {
  selectedCountry: CountryData | null;
  selectedMetric: MetricType;
  onSelectCountry: (country: CountryData) => void;
}

const WorldMap: React.FC<WorldMapProps> = ({ selectedCountry, selectedMetric, onSelectCountry }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredCountries, setFilteredCountries] = useState<CountryData[]>([]);
  const [isSearchFocused, setIsSearchFocused] = useState(false);

  useEffect(() => {
    if (searchTerm) {
      const filtered = countryData.filter(country => 
        country.name.toLowerCase().includes(searchTerm.toLowerCase())
      );
      setFilteredCountries(filtered);
    } else {
      setFilteredCountries([]);
    }
  }, [searchTerm]);

  // Sample country shapes (simplified for demo)
  const countryPaths: Record<string, string> = {
    cn: "M785.69,235.54 L815.12,228.75 L828.43,226.16 L834.38,232.95 L844.48,237.93 L851.26,243.88 L857.22,242.13 L859.80,246.28 L866.58,244.53 L872.54,249.51 L879.32,248.59 L884.45,251.18 L889.58,249.59 L890.83,253.87 L895.63,252.87 L899.19,257.85 L906.30,259.27 L909.53,262.19 L915.48,259.60 L919.87,262.19 L924.59,259.60 L928.06,264.58 L935.67,260.84 L941.62,265.83 L946.75,263.91 L950.55,267.74 L949.30,272.72 L954.43,275.31 L954.43,280.29 L963.69,285.28 L969.65,282.26 L974.77,284.44 L981.56,279.46 L988.34,282.04 L988.34,289.34 L994.30,290.42 L998.18,294.90 L1004.30,293.94 L1013.56,297.91 L1013.56,304.62 L1009.27,305.70 L1006.69,310.69 L1000.73,309.61 L992.63,316.91 L992.63,321.89 L986.68,327.96 L993.46,332.45 L991.80,335.62 L984.10,337.70 L977.31,335.12 L977.31,330.13 L971.36,328.13 L966.23,330.13 L964.90,334.74 L958.03,335.08 L953.24,341.14 L946.45,342.22 L936.92,351.11 L933.03,357.18 L933.03,365.56 L926.25,371.62 L926.25,380.00 L918.89,382.59 L913.76,376.52 L907.81,375.44 L904.34,380.00 L899.63,375.44 L886.32,383.83 L879.53,383.83 L873.58,380.00 L869.98,387.14 L862.44,391.05 L857.31,396.04 L846.23,391.05 L842.30,391.05 L839.44,397.32 L830.18,399.49 L827.59,405.80 L836.86,411.53 L842.81,416.52 L848.77,421.50 L850.51,429.89 L846.23,433.17 L843.65,439.85 L840.24,443.15 L836.87,450.12 L832.57,452.71 L831.90,458.77 L825.95,461.36 L820.00,456.37 L820.00,463.95 L816.11,471.34 L821.24,475.90 L822.91,485.82 L830.69,488.83 L835.46,495.01 L828.63,503.40 L826.00,513.77 L826.00,519.04 L820.00,520.29 L816.11,526.21 L808.32,527.67 L803.19,522.68 L797.24,526.36 L794.65,533.25 L787.87,540.64 L791.34,546.70 L787.87,550.01 L794.65,554.01 L794.65,561.81 L784.67,562.43 L784.67,568.07 L780.54,571.08 L774.59,571.08 L770.79,574.82 L763.17,573.74 L755.39,577.34 L753.63,583.23 L757.10,588.22 L747.84,595.03 L747.04,602.33 L740.25,602.33 L734.30,607.32 L734.30,614.43 L724.20,617.41 L723.37,620.48 L713.28,622.57 L706.49,620.48 L706.49,612.59 L699.71,617.58 L692.93,614.99 L686.97,622.34 L680.19,622.34 L675.89,617.38 L681.34,615.63 L673.31,611.77 L667.36,609.18 L667.36,603.12 L661.40,601.61 L661.40,594.22 L656.28,588.16 L649.49,587.81 L646.02,595.30 L640.07,586.92 L644.36,577.45 L644.36,572.47 L637.57,571.39 L637.57,564.00 L630.42,558.52 L624.83,551.13 L618.04,551.13 L615.46,546.15 L608.67,546.15 L608.67,540.08 L602.72,539.00 L595.93,544.66 L590.81,539.68 L590.81,534.70 L584.86,532.11 L584.86,521.55 L578.07,521.55 L578.07,513.08 L583.20,513.08 L583.20,500.55 L589.15,497.97 L589.15,492.98 L585.68,487.08 L578.90,487.08 L578.90,479.61 L572.94,479.61 L572.94,472.23 L567.22,468.32 L561.27,463.34 L567.22,459.51 L573.43,451.04 L580.21,451.04 L585.54,440.44 L592.32,440.44 L598.27,434.38 L604.14,431.42 L609.01,422.91 L616.05,419.49 L623.58,419.49 L626.16,414.50 L633.78,415.25 L639.73,411.37 L639.73,405.47 L647.51,405.47 L652.64,401.57 L658.60,404.31 L664.54,400.79 L671.33,400.79 L677.28,394.73 L684.06,394.73 L689.61,388.42 L679.44,383.17 L679.44,370.46 L686.22,370.46 L694.83,362.00 L694.83,355.94 L704.10,348.54 L710.04,351.04 L712.62,346.05 L720.03,343.46 L732.72,343.46 L739.50,350.85 L745.45,350.85 L752.24,344.79 L758.19,344.79 L765.81,340.89 L771.76,344.79 L777.71,342.20 L785.32,342.20 L791.28,337.21 L796.49,337.21 L808.32,324.48 L811.80,319.50 L817.75,317.99 L825.37,310.61 L832.15,310.61 L838.11,304.54 L841.58,304.54 L847.53,298.48 L854.32,298.48 L861.10,295.89 L871.86,296.97 L878.65,291.99 L885.43,290.91 L891.38,282.44 L898.17,280.93 L904.12,275.95 L910.90,273.36 L910.90,267.29 L917.69,261.23 L923.64,259.72 L930.42,254.74 L931.26,248.67 L924.48,246.09 L922.48,241.10 L916.53,241.10 L909.75,236.12 L903.79,236.12 L896.10,242.18 L890.14,236.12 L883.36,236.12 L877.41,242.18 L879.99,247.17 L873.21,249.75 L867.73,254.74 L861.36,253.66 L855.40,258.64 L847.37,252.58 L840.10,257.56 L834.14,257.56 L829.01,262.55 L823.06,258.64 L817.11,258.64 L810.32,253.66 L804.37,253.66 L797.58,246.28 L791.63,246.28 L784.85,242.38 L784.85,236.31",
    mx: "M211.08,356.40 L207.72,351.78 L208.31,347.75 L214.44,346.67 L217.61,355.32 L214.44,359.72 L211.08,356.40 M200,289.34 L208.34,282.67 L214.43,282.67 L217.02,288.01 L223.81,291.68 L229.76,291.68 L235.72,294.26 L240.35,296.85 L243.08,304.23 L249.87,307.91 L254.99,316.29 L260.95,321.27 L266.90,326.26 L271.02,327.34 L274.50,335.81 L277.08,335.81 L276.26,342.45 L281.38,342.45 L285.33,351.16 L285.33,354.92 L293.12,362.77 L293.12,368.36 L286.33,374.43 L286.33,380.49 L280.38,383.08 L277.79,387.89 L272.67,387.89 L266.71,389.39 L266.71,394.96 L260.75,394.96 L254.80,388.89 L249.67,388.89 L248.01,383.91 L242.90,383.91 L242.90,379.93 L240.32,379.93 L237.73,372.54 L231.77,372.54 L225.82,369.26 L219.04,366.67 L217.29,358.20 L214.43,346.67 L208.31,347.75 L207.72,351.78 L202.59,351.78 L202.59,343.29 L195.80,343.29 L195.80,336.57 L189.85,331.59 L189.85,326.27 L184.73,321.27 L184.73,316.29 L177.94,313.70 L177.94,307.64 L172.82,307.64 L166.86,313.70 L161.74,313.70 L155.78,308.72 L149.83,312.40 L144.71,307.64 L138.75,307.64 L136.17,304.87 L129.38,304.87 L128.93,299.89 L122.60,299.89 L122.60,304.87 L116.64,307.46 L109.86,307.46 L109.86,303.56 L103.91,299.62 L98.31,294.64 L98.31,289.65 L92.36,289.65 L92.36,282.68 L85.57,282.68 L85.57,274.21 L90.70,274.21 L90.70,265.74 L97.48,265.74 L103.44,259.68 L109.39,258.60 L115.34,253.62 L122.13,253.62 L128.08,250.52 L134.03,250.52 L140.82,258.60 L145.94,261.18 L152.73,261.18 L158.68,258.60 L164.64,258.60 L170.59,264.66 L175.72,264.66 L181.67,270.72 L187.62,270.72 L193.58,276.79 L200.00,289.34",
    ca: "M292.27,151.03 L289.69,145.85 L292.27,142.17 L293.93,147.16 L291.26,152.14 L292.27,151.03 M328.72,250.52 L323.59,250.52 L321.01,255.50 L313.36,255.50 L308.75,267.33 L301.95,267.33 L295.99,261.35 L290.37,261.35 L290.37,267.33 L285.74,267.33 L285.74,273.29 L280.63,273.29 L280.63,287.14 L274.67,287.14 L274.67,275.88 L269.54,275.88 L264.42,282.76 L259.29,282.76 L259.29,275.88 L245.98,277.38 L245.98,267.33 L240.86,267.33 L240.86,260.27 L231.59,260.27 L231.59,266.25 L225.64,266.25 L225.64,255.50 L219.69,255.50 L219.69,248.43 L212.90,248.43 L212.90,241.47 L206.95,241.47 L206.95,231.41 L200.16,231.41 L200.16,221.44 L194.21,221.44 L193.30,231.41 L187.42,231.41 L187.42,221.44 L181.67,221.44 L181.67,216.36 L174.89,216.36 L174.89,223.94 L168.93,223.94 L168.93,231.41 L163.81,231.41 L163.81,238.38 L157.35,238.38 L157.35,244.45 L163.31,244.45 L163.31,250.52 L170.10,250.52 L170.10,244.45 L177.72,244.45 L177.72,250.52 L184.51,250.52 L184.51,256.50 L190.46,256.50 L190.46,265.06 L196.42,265.06 L196.42,272.53 L190.46,275.03 L190.46,281.18 L180.45,281.18 L180.45,272.53 L174.49,272.53 L174.49,265.06 L167.71,265.06 L167.71,258.09 L160.92,258.09 L154.97,252.02 L148.18,252.02 L148.18,260.27 L142.68,260.27 L142.68,271.11 L137.10,271.11 L137.10,265.06 L130.31,265.06 L130.31,271.11 L124.36,271.11 L124.36,277.19 L118.40,277.19 L118.40,265.06 L112.45,265.06 L112.45,258.09 L105.66,258.09 L99.71,252.02 L92.92,252.02 L92.92,231.41 L86.96,231.41 L83.13,224.47 L76.34,224.47 L76.34,231.41 L70.39,231.41 L70.39,224.47 L63.60,224.47 L63.60,231.41 L57.65,231.41 L57.65,224.47 L50.86,224.47 L50.86,217.51 L44.91,217.51 L44.91,210.04 L50.86,210.04 L50.86,193.91 L45.74,193.91 L45.74,184.34 L51.70,184.34 L51.70,177.38 L45.74,177.38 L45.74,162.98 L39.79,162.98 L39.79,149.04 L32.09,149.04 L32.09,141.15 L38.04,141.15 L38.04,131.09 L44.91,131.09 L44.91,118.43 L50.86,118.43 L50.86,111.38 L56.81,111.38 L56.81,104.41 L62.76,104.41 L62.76,95.94 L69.55,95.94 L69.55,85.97 L63.60,85.97 L63.60,76.91 L57.65,76.91 L57.65,65.35 L50.86,65.35 L50.86,58.38 L44.11,58.38 L44.11,36.24 L39.79,36.24 L39.79,26.18 L201.99,26.18 L201.99,29.36 L343.70,29.36 L337.15,37.83 L337.15,44.79 L343.94,44.79 L343.94,49.78 L337.15,54.76 L337.15,61.73 L331.20,61.73 L331.20,68.70 L324.42,68.70 L324.42,74.68 L318.46,74.68 L313.34,79.66 L307.39,79.66 L304.80,85.64 L292.87,85.64 L292.87,90.62 L285.25,90.62 L285.25,97.60 L278.46,97.60 L272.50,92.61 L265.72,92.61 L265.72,98.68 L256.45,98.68 L250.50,103.66 L243.71,103.66 L236.93,107.47 L230.97,107.47 L230.97,118.35 L236.93,118.35 L236.93,123.32 L230.97,129.59 L228.14,135.37 L224.81,131.64 L217.57,131.64 L217.57,136.62 L211.62,136.62 L211.62,142.60 L200.16,142.60 L200.16,135.63 L195.86,135.63 L195.86,118.35 L190.10,118.35 L190.10,129.30 L184.15,129.30 L184.15,143.68 L177.36,143.68 L177.36,154.82 L184.15,154.82 L184.15,162.38 L190.10,162.38 L190.10,168.36 L196.89,168.36 L196.89,174.34 L202.84,174.34 L202.84,180.31 L208.80,180.31 L208.80,168.36 L214.75,168.36 L214.75,161.39 L221.54,161.39 L221.54,155.33 L228.33,155.33 L234.28,149.35 L234.28,142.38 L241.07,142.38 L241.07,135.34 L247.02,135.34 L252.98,129.35 L260.58,129.35 L260.58,135.34 L267.36,135.34 L267.36,142.38 L274.15,142.38 L274.15,149.35 L280.10,149.35 L280.10,156.41 L285.49,156.41 L285.49,162.38 L291.44,162.38 L291.44,155.33 L298.23,155.33 L298.23,162.38 L304.18,162.38 L304.18,169.53 L310.97,169.53 L318.80,175.42 L324.75,175.42 L324.75,181.40 L331.54,181.40 L336.66,187.38 L343.44,187.38 L349.40,193.36 L355.35,193.36 L361.31,199.33 L368.09,199.33 L374.05,205.31 L380.00,205.31 L380.00,212.28 L374.05,212.28 L374.05,222.52 L358.77,222.52 L358.77,228.50 L352.82,228.50 L352.82,234.48 L346.03,234.48 L346.03,240.46 L339.25,240.46 L339.25,246.44 L332.46,246.44 L332.46,252.42 L325.67,252.42 L325.67,246.44 L320.55,246.44 L320.55,250.52 L328.72,250.52",
    jp: "M893.26,230.23 L887.30,235.21 L877.71,241.19 L867.75,241.19 L859.55,235.21 L859.55,230.23 L870.33,225.25 L881.61,226.36 L892.39,227.44 L893.26,230.23 M876.37,296.66 L870.42,301.82 L864.47,296.66 L870.42,291.68 L876.37,296.66 M856.13,248.55 L858.72,242.57 L864.67,247.56 L871.46,253.54 L865.51,258.52 L859.55,262.43 L853.60,260.66 L856.13,248.55 M913.48,215.85 L917.79,222.62 L915.20,227.65 L909.25,222.66 L904.95,213.22 L913.48,215.85 M926.91,208.88 L923.44,217.26 L918.31,213.44 L926.91,208.88",
    de: "M498.06,183.09 L503.18,190.58 L509.13,186.27 L514.26,187.89 L515.91,193.87 L522.70,193.87 L529.48,202.09 L524.36,208.61 L516.57,211.85 L509.79,210.44 L503.18,214.79 L496.40,214.79 L496.40,219.77 L490.44,219.77 L490.44,212.20 L484.49,212.20 L484.49,200.74 L477.70,200.74 L477.70,194.13 L484.49,193.32 L489.61,190.04 L492.91,183.13 L498.06,183.09",
    vn: "M806.73,388.89 L802.43,398.43 L795.65,404.40 L795.65,416.79 L789.69,429.89 L782.91,442.16 L776.96,451.04 L770.16,454.13 L763.38,448.14 L757.42,440.72 L753.29,431.88 L747.34,422.91 L747.34,414.90 L753.29,406.99 L761.23,403.32 L768.02,398.34 L774.81,388.89 L783.31,380.91 L789.26,380.91 L793.89,383.83 L802.02,385.99 L806.73,388.89",
    kr: "M871.00,276.38 L867.53,285.84 L860.74,285.84 L853.60,280.37 L860.74,274.89 L868.37,269.41 L871.00,276.38",
    in: "M641.72,388.89 L647.68,388.89 L652.80,383.91 L658.76,387.89 L664.71,383.91 L669.84,383.91 L675.79,378.93 L675.79,372.05 L681.73,372.05 L685.21,378.93 L690.33,378.93 L696.29,372.05 L701.41,372.05 L707.37,366.07 L712.49,366.07 L712.49,359.19 L706.54,351.62 L699.75,351.62 L693.80,344.64 L686.01,340.91 L682.54,337.22 L670.22,337.22 L664.27,341.11 L664.27,348.09 L658.31,353.07 L651.53,348.09 L651.53,340.91 L645.57,336.14 L638.78,336.14 L638.78,328.74 L632.83,329.16 L628.53,325.85 L622.58,329.16 L616.62,322.18 L611.50,322.18 L611.50,317.20 L606.37,316.12 L606.37,328.74 L601.25,334.14 L605.96,335.67 L603.84,342.20 L603.84,348.09 L597.04,351.62 L596.64,358.11 L599.43,363.48 L596.64,371.55 L603.84,376.34 L604.26,384.81 L596.64,390.97 L589.86,390.97 L589.86,397.84 L596.64,403.93 L595.81,409.92 L600.92,415.99 L607.71,419.49 L614.50,419.49 L617.08,414.50 L623.87,414.50 L629.82,408.52 L636.61,408.52 L641.72,398.76 L641.72,388.89",
    tw: "M845.40,355.94 L840.28,361.92 L839.45,368.90 L845.40,361.92 L845.40,355.94",
    ie: "M430.53,183.09 L425.40,186.88 L419.45,186.88 L413.84,181.99 L413.84,175.52 L419.45,175.52 L425.40,178.60 L430.53,183.09",
    it: "M503.18,271.62 L498.06,259.59 L498.06,253.53 L501.53,248.55 L509.13,248.55 L515.09,242.57 L515.09,231.70 L509.13,230.23 L502.35,231.70 L502.35,225.25 L496.40,220.85 L496.40,214.79 L503.18,214.79 L509.13,212.28 L516.57,211.85 L521.04,206.08 L526.82,206.08 L532.78,212.28 L539.56,212.28 L535.37,217.17 L535.37,224.15 L521.04,224.15 L516.91,229.84 L522.87,233.86 L522.87,239.74 L516.91,245.96 L509.13,245.96 L509.13,252.53 L515.91,258.52 L515.91,264.29 L509.13,267.82 L503.18,271.62",
    gb: "M438.31,183.09 L444.27,176.61 L451.05,176.61 L456.18,181.59 L450.22,187.47 L445.10,187.47 L438.31,183.09 M455.35,173.54 L456.18,168.27 L462.14,168.27 L464.72,174.25 L455.35,173.54",
    fr: "M480.18,200.74 L486.13,200.74 L486.13,208.30 L492.08,208.30 L492.08,214.79 L486.13,214.79 L486.13,230.23 L477.70,231.70 L471.74,225.33 L465.79,225.33 L465.79,221.35 L459.84,221.35 L459.84,215.37 L453.06,215.37 L453.06,210.69 L448.76,203.41 L448.76,196.43 L453.06,190.45 L459.84,190.45 L460.66,196.43 L465.79,196.43 L471.74,202.41 L477.70,200.74 L480.18,200.74",
    my: "M762.55,401.77 L756.59,401.77 L756.59,409.84 L749.80,409.84 L749.80,422.91 L762.55,422.91 L768.02,414.93 L774.81,414.93 L774.81,407.47 L768.02,407.47 L768.02,401.77 L762.55,401.77 M808.32,387.89 L815.10,387.89 L820.73,395.36 L815.10,401.77 L808.32,401.77 L802.36,401.77 L795.98,409.84 L789.69,409.84 L789.69,401.77 L782.91,401.77 L776.96,401.77 L770.16,396.36 L770.16,387.89 L776.96,387.89 L782.91,387.89 L789.69,383.91 L796.48,387.89 L802.43,387.89 L808.32,387.89",
    th: "M762.55,358.76 L768.50,358.76 L776.13,366.07 L782.91,366.07 L782.91,380.59 L776.96,380.59 L769.33,388.89 L762.55,393.87 L755.76,393.87 L749.80,397.76 L743.01,397.76 L740.43,389.97 L736.96,383.91 L733.49,380.00 L733.49,372.85 L739.44,366.07 L745.40,365.56 L751.35,359.48 L756.47,359.48 L762.55,358.76",
  };

  return (
    <div className="w-full h-full bg-white rounded-lg overflow-hidden shadow-sm border">
      <div className="p-3 border-b">
        <div className="relative mb-2">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="text"
            placeholder="Search countries..."
            className="pl-9 h-9"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            onFocus={() => setIsSearchFocused(true)}
            onBlur={() => setTimeout(() => setIsSearchFocused(false), 100)}
          />
          
          {isSearchFocused && filteredCountries.length > 0 && (
            <div className="absolute z-10 w-full bg-white border rounded-md shadow-md mt-1 max-h-60 overflow-y-auto">
              {filteredCountries.map((country) => (
                <div
                  key={country.id}
                  className="p-2 hover:bg-muted cursor-pointer"
                  onClick={() => {
                    onSelectCountry(country);
                    setSearchTerm('');
                  }}
                >
                  {country.name}
                </div>
              ))}
            </div>
          )}
        </div>
        
        <div className="flex flex-wrap gap-1 items-center text-xs text-muted-foreground">
          <span>Selected metric:</span>
          <span className="font-medium text-foreground">
            {selectedMetric ? metricOptions.find(m => m.id === selectedMetric)?.label : 'None'}
          </span>
        </div>
      </div>
      
      <div className="relative h-[400px] w-full overflow-hidden">
        <svg
          width="100%"
          height="100%"
          viewBox="0 0 1200 650"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          className="absolute inset-0"
        >
          <g className="map-countries">
            {countryData.map((country) => (
              <path
                key={country.id}
                d={countryPaths[country.id] || ''}
                fill={getCountryColor(country, selectedMetric)}
                stroke={selectedCountry?.id === country.id ? '#000' : '#fff'}
                strokeWidth={selectedCountry?.id === country.id ? 2 : 0.5}
                onClick={() => onSelectCountry(country)}
                className="cursor-pointer transition-colors duration-200 hover:stroke-black hover:stroke-2"
              />
            ))}
          </g>
        </svg>
        
        <div className="absolute bottom-4 right-4 bg-white/80 backdrop-blur-sm p-2 rounded-md border shadow-sm">
          <div className="text-xs text-muted-foreground mb-1">Legend</div>
          <div className="flex gap-2 items-center">
            <div className="flex flex-col gap-1">
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 bg-cyan-700 opacity-80 rounded-sm"></div>
                <span className="text-xs">High value</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 bg-cyan-700 opacity-30 rounded-sm"></div>
                <span className="text-xs">Low value</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 bg-gray-200 rounded-sm"></div>
                <span className="text-xs">No data</span>
              </div>
            </div>
            
            {(selectedMetric === 'usTradeBalance') && (
              <div className="flex flex-col gap-1 ml-4 border-l pl-4">
                <div className="flex items-center gap-1">
                  <div className="w-3 h-3 bg-red-500 opacity-80 rounded-sm"></div>
                  <span className="text-xs">Trade deficit</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-3 h-3 bg-blue-500 opacity-80 rounded-sm"></div>
                  <span className="text-xs">Trade surplus</span>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default WorldMap;
